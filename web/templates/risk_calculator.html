{% extends "base.html" %}

{% block content %}

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='js/scripts.js') }}"></script>

<div>
<h1 class="page-heading">Risk Calculator</h1>
</div>
<!-- Section for importing Excel file and calculating risk score -->
<div id="input-section">
    <form id="excel-form" enctype="multipart/form-data">
        <input type="file" id="excel-file" name="excel_file" accept=".xlsx, .xls">
        <button type="submit">Import Excel</button>
    </form>
    <button id="calculate-risk-score" type="button">Calculate Risk Score</button>
    <h2 id="risk-score-value"></h2>
</div>

<hr>

<!-- Section divided into two columns -->
<div style="display: flex;">
    <!-- First column: Display imported data in tables -->
    <div style="flex: 1;">
        <h2>Routes</h2>
        <table id="routes-table">
            <thead>
                <tr>
                    <th>Route ID</th>
                    <th>Load Port</th>
                    <th>Discharge Port</th>
                    <th>Coordinates</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated here -->
            </tbody>
        </table>

        <h2>Incidents</h2>
        <table id="incidents-table">
            <thead>
                <tr>
                    <th>Incident ID</th>
                    <th>Route ID</th>
                    <th>Description</th>
                    <th>Risk Score</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Second column: Leaflet map -->
    <div style="flex: 1;">
        <div id="map" style="height: 600px;"></div>
    </div>
</div>

<script>
    // Mock routes for initial map rendering
    const mockRoutes = [
        {
            "route_id": 1,
            "coordinates": [[3.337954, -78.925776]
                            ,[-1.757537, -83.847651]
                            ,[-11.523087, -78.925776]
                            ,[-26.745610, -75.761714]
                            ,[-35.173808, -74.707026]
                            ,[-47.040181, -78.574214]
                            ,[-55.677584, -75.937495]
                            ,[-57.421294, -64.335933]
                            ,[-54.367758, -63.281246]
                            ,[-49.037867, -65.917965]
                            ,[-41.508577, -61.699215]
                            ,[-35.603718, -55.371090]
                            ,[-23.241346, -41.484372]
                            ,[-10.833306, -32.695310]
                            ,[8.059229, -14.062499]
                            ,[3.513421, -2.285156]
                            ,[-2.986927, 8.437499]]
        },
    ];


    const cities = [
    { name: 'London', coordinates: [51.505, -0.09] },
    { name: 'Paris', coordinates: [48.8566, 2.3522] },
    { name: 'New York', coordinates: [40.7128, -74.0060] },
    { name: 'Los Angeles', coordinates: [34.0522, -118.2437] },
    { name: 'Tokyo', coordinates: [35.6895, 139.6917] },
    { name: 'Sydney', coordinates: [-33.8688, 151.2093] },
    { name: 'Cairo', coordinates: [30.0444, 31.2357] },
    { name: 'Rio de Janeiro', coordinates: [-22.9068, -43.1729] },
    { name: 'Moscow', coordinates: [55.7558, 37.6173] },
    { name: 'Mumbai', coordinates: [19.0760, 72.8777] }
];


function generateRoutes(cities) {
    let routes = [];
    for (let i = 0; i < cities.length; i++) {
        for (let j = i + 1; j < cities.length; j++) {
            routes.push({
                coordinates: [cities[i].coordinates, cities[j].coordinates],
                color: 'blue',  // Default color for routes
                startCity: cities[i].name,
                endCity: cities[j].name
            });
        }
    }
    return routes;
}

var map;
function renderMap(routes) {
    try {
        // Check if a map instance already exists
        if (map !== undefined) {
            // Remove the existing map instance
            map.remove();
        }

        // Initialize the map
        map = L.map('map').setView([20, 0], 2);  // Default view is set to be more inclusive of the world map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Loop through routes and add polylines and markers to the map
        routes.forEach(route => {
            // Add polyline for the route
            L.polyline(route.coordinates, { color: route.color || 'blue' }).addTo(map);

            // Add markers for the start and end points
            var startPoint = route.coordinates[0];
            var endPoint = route.coordinates[route.coordinates.length - 1];

            L.marker(startPoint).addTo(map)
                .bindPopup(route.startCity || 'Start City')
                .openPopup();

            L.marker(endPoint).addTo(map)
                .bindPopup(route.endCity || 'End City')
                .openPopup();
        });
    } catch (e) {
        console.error(e);
        alert('Error rendering map: ' + e.message);
    }
}

    function renderMapWcolor(routes) {
        // Leaflet map initialization (replace with your preferred map setup)
        try
        {
        var map = L.map('map').setView([51.505, -0.09], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Loop through routes and add polylines to the map
        routes.forEach(route => {
            L.polyline(route.coordinates, { color: 'green' }).addTo(map);
        });
        }
        catch (e)
        {
            console.log(e);
            alert('Error importing Excel file:', e)
        }
        
    }

    // Initial map rendering
    // Generate routes from the list of cities
    const routes = generateRoutes(cities);
    renderMap(routes);

    // Event listener for Excel file import form submission
    document.getElementById('excel-form').addEventListener('submit', function (e) {
        e.preventDefault();
        var formData = new FormData();
        formData.append('excel_file', document.getElementById('excel-file').files[0]);
        
        fetch('/import_excel', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Display imported data in the UI
            populateTables(data.routes, data.incidents);
            renderMap(data.routes);
        })
        .catch(error => alert('Error importing Excel file:', error));
    });

    // Function to populate tables with imported data
    function populateTables(routes, incidents) {
        // Populate routes table
        const routesTableBody = document.getElementById('routes-table').getElementsByTagName('tbody')[0];
        routesTableBody.innerHTML = ''; // Clear existing rows
        routes.forEach(route => {
            const row = routesTableBody.insertRow();
            row.insertCell(0).textContent = route.route_id;
            row.insertCell(1).textContent = route.load_port;
            row.insertCell(2).textContent = route.discharge_port;
            row.insertCell(3).textContent = route.discharge_port;
        });

        // Populate incidents table
        const incidentsTableBody = document.getElementById('incidents-table').getElementsByTagName('tbody')[0];
        incidentsTableBody.innerHTML = ''; // Clear existing rows
        incidents.forEach(incident => {
            const row = incidentsTableBody.insertRow();
            row.insertCell(0).textContent = incident.incident_id;
            row.insertCell(1).textContent = incident.route_id;
            row.insertCell(2).textContent = incident.description;
            row.insertCell(3).textContent = incident.risk_score;
        });
    }

    // Event listener for Calculate Risk Score button
    document.getElementById('calculate-risk-score').addEventListener('click', function () {
        fetch('/calculate_risk_score', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            // Display calculated risk score in the UI
            document.getElementById('risk-score-value').textContent = 'Calculated Risk Score: ' + data.risk_score;
        })
        .catch(error => console.error('Error calculating risk score:', error));
    });

</script>

{% endblock %}
